# ClickHouse架构

Clickhouse 的数据结构类似于关系型数据库，包括解析器，主要负责将SQL语句通过词法分析和语法分析，转化为计算机可以读取的抽象语法树。 另外，优化器负责优化抽象语法树的逻辑，比如简化一些冗长难懂的表达式，做一些语义优化。 物理优化负责生成可以直接执行的物理执行计划，指导数据库管理系统如何获取数据表，如何对数据进行join和排序等。

![clickhouse架构图](./clickhouse架构图.png)

&nbsp;

### Column与Field

`Column` 和 `Field` 是Clickhouse数据最基础的映射单元。Clickhouse按列存储数据，内存中的一列数据由一个 `Column` 对象表示，`Column` 对象分为接口和实现两部分。如果需要操作单个值(单列中的一行数据)，需要使用 `Field` 对象，`Field` 对象代表一个单值。

### DataType

DataType负责数据的序列化和发序列化，`IDataType` 接口定义了许多正反序列化的方法。DataType 虽然负责序列化先关工作，但它并不直接负责数据的读取，而是转由从 `Column` 或 `Field` 对象获取。

&nbsp;

## 数据流图

Clickhouse 的物理执行计划可以看成是一个数据流图，即数据的有向无环图。 在此图中，数据从一个管道传递到另一个管道，即从一个操作员传递到另一个管道。 查询执行器是用于执行计划的引擎。 它从存储引擎获取数据并将其返回给客户端。

![query.jpg](./query.jpg)

Clickhouse在启动时加载配置信息，然后根据不同的解析协议监听不同的服务端口。 客户端发出SQL请求后，会先解析SQL语法，然后生成抽象语法树，并进行一系列的逻辑优化和物理优化，生成执行计划。 接下来，不同的执行器根据SQL请求将执行计划分发到本地或远程存储引擎，并从存储引擎中获取数据。 经过一系列的计算和处理，数据返回给客户端，客户端可以输出缓冲区读取查询结果。
